<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cash Flow | IndoStock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        
        /* Floating Action Button (FAB) */
        .fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 4rem;
            height: 4rem;
            background-color: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.5);
            z-index: 45;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .fab:active { transform: scale(0.9) rotate(90deg); }

        /* Form Styling (Identik dengan Dashboard) */
        input, select, textarea { 
            background-color: #0f172a !important; 
            border: 2px solid #334155 !important; 
            color: #10b981 !important; 
            font-weight: 800 !important;
        }
        input::placeholder { color: #475569 !important; font-weight: 400; }
        input:focus { border-color: #10b981 !important; outline: none; }
        #jumlah { color: #f8fafc !important; }

        /* Modal Overlay & Animation */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 60; backdrop-filter: blur(8px);
        }
        .modal-overlay.show-flex { display: flex !important; align-items: center; justify-content: center; padding: 1rem; }
        #cashModal { transition: all 0.3s ease; transform: translateY(20px); opacity: 0; }
        #cashModal.active { transform: translateY(0); opacity: 1; }

        /* Sidebar & Layout */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; }
        .sidebar-overlay.active { display: block; }
        
        .stat-card {
            background-color: #1e293b; border: 1px solid #334155; padding: 1.5rem;
            border-radius: 1.25rem; display: flex; flex-direction: column; align-items: center;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-[#0f172a]">

    <div id="sidebarOverlay" class="sidebar-overlay md:hidden" onclick="toggleSidebar()"></div>

    <button onclick="toggleModal()" class="fab md:hidden">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M12 4v16m8-8H4"/></svg>
    </button>

    <div id="modalOverlay" class="modal-overlay">
        <div id="cashModal" class="w-full max-w-lg bg-[#1e293b] rounded-[2.5rem] shadow-2xl border border-slate-700 overflow-hidden">
            <div class="p-6 md:p-8 flex justify-between items-center border-b border-slate-700">
                <h2 class="text-2xl font-black text-emerald-400 italic">CASH FLOW</h2>
                <button onclick="toggleModal()" class="text-slate-400 text-3xl">&times;</button>
            </div>
            <form id="cashForm" class="p-6 md:p-8 space-y-5">
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Tipe Transaksi</label>
                    <select id="tipe" class="w-full p-4 rounded-2xl">
                        <option value="TOPUP">TOP UP (MODAL MASUK)</option>
                        <option value="WITHDRAW">WITHDRAW (TARIK DANA)</option>
                    </select>
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Jumlah (Rp)</label>
                    <input type="number" id="jumlah" placeholder="0" required class="w-full p-4 rounded-2xl">
                </div>
                <div class="flex flex-col gap-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Keterangan</label>
                    <textarea id="keterangan" placeholder="Contoh: Deposit awal RDN" class="w-full p-4 rounded-2xl h-24 font-bold"></textarea>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-emerald-600 py-5 rounded-2xl font-black text-xl uppercase text-white active:scale-95 transition-all">Simpan Mutasi</button>
            </form>
        </div>
    </div>

<aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-[#1e293b] border-r border-slate-700 p-6 flex flex-col z-50 transform -translate-x-full md:translate-x-0 md:sticky md:top-0 h-screen">        <h1 class="text-2xl font-black text-emerald-400 mb-10 italic tracking-tighter">INDOSTOCK</h1>
        <nav class="flex flex-col gap-1 min-h-[70vh] md:min-h-[80vh]">
            <button onclick="toggleModal()" class="hidden md:flex items-center justify-center gap-3 bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 px-4 rounded-2xl mb-8 shadow-lg shadow-emerald-900/40 transition-all active:scale-95">
    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path d="M12 4v16m8-8H4" /></svg>
                <span>ADD MODAL</span>
            </button>

            <a href="index.html" class="flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition font-bold uppercase text-xs tracking-widest">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" /><path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" /></svg>
                Dashboard
            </a>
            <a href="uang.html" class="flex items-center gap-3 p-4 rounded-xl bg-slate-800 text-emerald-400 font-bold border border-slate-700 uppercase text-xs tracking-widest">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Uang
            </a>
            <a href="history.html" class="flex items-center gap-3 p-3 rounded-xl text-slate-400 hover:bg-slate-800 hover:text-white transition font-bold uppercase text-xs tracking-widest">
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                History
            </a>
        </nav>
        <div class="relative mt-auto flex items-center" id="profileArea">
             <button onclick="toggleDropdown()" class="flex items-center gap-3 p-1.5 rounded-2xl hover:bg-slate-800/50 transition-all border border-transparent hover:border-slate-700">
       <div class="w-9 h-9 rounded-xl bg-slate-800 border border-slate-700 overflow-hidden shadow-inner">
            <img src="" id="userPhotoDisplay" class="w-full h-full object-cover" alt="Profile">
        </div>
        <div class="text-left hidden md:block">
            <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest leading-none">Trader</p>
            <p id="userNameDisplay" class="text-xs font-black text-emerald-400">Loading...</p>
        </div>    
    </button>

    <div id="dropdownMenu" class="absolute right-0 bottom-full mt-3 w-44 bg-[#1e293b] border border-slate-700 rounded-2xl shadow-2xl py-2 hidden z-[999]">
        <div class="px-4 py-2 border-b border-slate-700/50 mb-1">
            <span class="text-[9px] font-black text-slate-500 uppercase">System Status</span>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                <p class="text-[11px] font-bold text-emerald-400">Online</p>
            </div>
        </div>
        
        <button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 text-rose-400 hover:bg-rose-500/10 transition-all group">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            <span class="text-[11px] font-black uppercase tracking-widest">Sign Out</span>
        </button>
    </div>
</div>
    </aside>

<main class="flex-1 w-full flex flex-col h-full overflow-y-auto">
<header class="md:hidden bg-[#1e293b] p-4 border-b border-slate-700 flex justify-between items-center sticky top-0 z-30">
                <h1 class="text-xl font-black text-emerald-400 italic">INDOSTOCK</h1>
            <button onclick="toggleSidebar()" class="p-2 bg-slate-800 rounded-lg text-emerald-400">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
        </header>

        <div class="p-4 md:p-8 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="stat-card">
                    <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Total Modal</p>
                    <h3 id="stat-modal" class="text-2xl font-black text-white text-center">Rp 0</h3>
                </div>
                <div class="stat-card">
                    <p class="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Total Penarikan</p>
                    <h3 id="stat-wd" class="text-2xl font-black text-rose-400 text-center">Rp 0</h3>
                </div>
                <div class="stat-card bg-gradient-to-br from-slate-800 to-emerald-900/20 border-emerald-500/30">
                    <p class="text-emerald-400 text-[10px] uppercase font-black tracking-widest mb-1">Total Equity (Modal + P/L)</p>
                    <h3 id="stat-equity" class="text-2xl font-black text-emerald-400 text-center">Rp 0</h3>
                </div>
            </div>

            <div class="bg-[#1e293b] p-4 md:p-6 rounded-[2.5rem] border border-slate-700 shadow-2xl overflow-hidden">
    <div class="flex justify-between items-center mb-4 px-2">
        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Equity Growth Curve</h3>
        <span class="text-[10px] bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded-lg font-bold">LIVE DATA</span>
    </div>
    <div class="h-64 w-full">
        <canvas id="equityChart"></canvas>
    </div>
</div>

            <div class="bg-[#1e293b] rounded-3xl border border-slate-700 overflow-hidden shadow-2xl">
                <div class="p-6 border-b border-slate-700 bg-slate-800/30 flex justify-between items-center">
    <h3 class="font-black text-slate-300 uppercase tracking-widest text-sm">Riwayat Setoran & Penarikan</h3>
    <button id="see-all-btn" onclick="toggleSeeAll()" class="text-[10px] font-black text-emerald-400 border border-emerald-400/30 px-3 py-1 rounded-lg hover:bg-emerald-400 hover:text-white transition-all">
        SEE ALL
    </button>
</div>
<div id="cash-list" class="divide-y divide-slate-700/50">
    </div>
                <div id="cash-list" class="divide-y divide-slate-700/50">
                    <div class="p-8 text-center text-slate-500 italic">Memuat riwayat dana...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Cek status login saat halaman dibuka
if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "login.html"; // Tendang balik ke login jika belum login
}

// Fungsi Logout
function logout() {
    localStorage.removeItem("isLoggedIn");
    window.location.href = "login.html";
}
function logout() {
    localStorage.removeItem("isLoggedIn");
    window.location.href = "login.html";
}
document.addEventListener("DOMContentLoaded", () => {
    // 1. Ambil data yang dikirim Apps Script saat login tadi
    const name = localStorage.getItem("displayName") || "Guest";
    const photo = localStorage.getItem("photoUrl");

    // 2. Tampilkan Nama ke UI
    const nameEl = document.getElementById("userNameDisplay");
    if(nameEl) nameEl.innerText = name;

    // 3. Tampilkan Foto ke UI
    const imgEl = document.getElementById("userPhotoDisplay");
    if(imgEl) {
        if (photo && photo.startsWith("http")) {
            imgEl.src = photo;
        } else {
            // Backup jika di Sheet3 kolom fotonya kosong
            imgEl.src = `https://ui-avatars.com/api/?name=${name}&background=10b981&color=fff&bold=true`;
        }
    }
});

// Fungsi buka-tutup menu
function toggleDropdown() {
    const menu = document.getElementById("dropdownMenu");
    menu.classList.toggle("hidden");
}

// Tutup menu jika klik di area luar
window.onclick = function(event) {
    if (!event.target.closest('#profileArea')) {
        const menu = document.getElementById("dropdownMenu");
        if (menu) menu.classList.add("hidden");
    }
}
        const scriptURL = 'https://script.google.com/macros/s/AKfycbxigXCHCY9T849VR5E88sZOWDYSkoEAdu57uDDMP1VFYK-ZXRCxKsPOIl9QFukvJolM/exec';

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('-translate-x-full');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        }

        function toggleModal() {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('cashModal');
            if (overlay.classList.contains('show-flex')) {
                modal.classList.remove('active');
                setTimeout(() => overlay.classList.remove('show-flex'), 300);
            } else {
                overlay.classList.add('show-flex');
                setTimeout(() => modal.classList.add('active'), 10);
            }
        }

        document.getElementById('cashForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerText = "SAVING..."; btn.disabled = true;

            const payload = {
                targetSheet: "Sheet2", // Memberi tahu GS untuk simpan di Sheet2
                tipe: document.getElementById('tipe').value,
                jumlah: parseFloat(document.getElementById('jumlah').value),
                keterangan: document.getElementById('keterangan').value
            };

            try {
                await fetch(scriptURL, { method: 'POST', body: JSON.stringify(payload) });
                location.reload();
            } catch (err) { 
                alert("Data Terkirim!"); 
                location.reload(); 
            }
        });
        // ... (kode toggleSidebar, toggleModal, dan form submit Anda yang sudah ada) ...

        let allHistoryData = []; // Variabel global untuk menampung semua data
let isSeeAll = false;    // Status apakah sedang melihat semua data

async function loadUangData() {
    try {
        const res = await fetch(scriptURL);
        const data = await res.json();
        
        allHistoryData = data.historyUang || []; // Simpan semua data ke variabel global
        
        // Update statistik angka (kode yang sudah ada tetap di sini)
        const fmt = (v) => `Rp ${v.toLocaleString('id-ID')}`;
        document.getElementById('stat-modal').innerText = fmt(data.stats.totalModal || 0);
        document.getElementById('stat-wd').innerText = fmt(data.stats.totalWD || 0);
        document.getElementById('stat-equity').innerText = fmt(data.stats.equity || 0);

        renderHistory(); // Panggil fungsi render history
        renderChart(data.historyUang, data.recentTrades);
        
    } catch (e) {
        console.error("Gagal memuat data:", e);
    }
}

// Fungsi baru untuk merender daftar riwayat
function renderHistory() {
    const listContainer = document.getElementById('cash-list');
    const btn = document.getElementById('see-all-btn');
    const fmt = (v) => `Rp ${v.toLocaleString('id-ID')}`;

    if (allHistoryData.length === 0) {
        listContainer.innerHTML = '<div class="p-8 text-center text-slate-500 font-bold italic">Belum ada mutasi dana.</div>';
        btn.style.display = 'none'; // Sembunyikan tombol jika data kosong
        return;
    }

    // Tentukan data mana yang akan ditampilkan (semua atau hanya 5)
    const dataToShow = isSeeAll ? allHistoryData : allHistoryData.slice(0, 5);
    
    listContainer.innerHTML = ''; 
    dataToShow.forEach(item => {
        const isTopup = item.tipe === "TOPUP";
        const tgl = new Date(item.tanggal).toLocaleDateString('id-ID', {
            day: 'numeric', month: 'short', year: 'numeric'
        });

        listContainer.innerHTML += `
            <div class="p-5 flex justify-between items-center border-b border-slate-700/50 hover:bg-slate-800/20 transition">
                <div>
                    <p class="text-[10px] font-black ${isTopup ? 'text-emerald-400' : 'text-rose-400'} uppercase tracking-tighter">${item.tipe}</p>
                    <p class="text-xs font-bold text-white mt-0.5">${item.ket || '-'}</p>
                    <p class="text-[9px] text-slate-500 font-bold uppercase mt-1">${tgl}</p>
                </div>
                <div class="text-right">
                    <p class="font-black ${isTopup ? 'text-emerald-400' : 'text-rose-400'}">
                        ${isTopup ? '+' : '-'}${fmt(item.jumlah)}
                    </p>
                </div>
            </div>
        `;
    });

    // Ubah teks tombol berdasarkan status
    btn.innerText = isSeeAll ? "SHOW LESS" : "SEE ALL";
}

// Fungsi untuk mengganti status See All
function toggleSeeAll() {
    isSeeAll = !isSeeAll;
    renderHistory();
}

        // PENTING: Panggil fungsi ini saat halaman dimuat
        window.onload = loadUangData;
        let myChart; // Variabel global untuk grafik

function renderChart(historyUang, recentTrades) {
    const ctx = document.getElementById('equityChart').getContext('2d');
    if (myChart) { myChart.destroy(); }

    // 1. Gabungkan data Mutasi Uang dan Trading ke dalam satu array timeline
    let timeline = [];

    // Masukkan data mutasi modal (Topup/WD)
    historyUang.forEach(item => {
        timeline.push({
            tanggal: new Date(item.tanggal),
            perubahan: item.tipe === "TOPUP" ? item.jumlah : -item.jumlah
        });
    });

    // Masukkan data hasil trading (Profit/Loss)
    recentTrades.forEach(item => {
        timeline.push({
            tanggal: new Date(item.date),
            perubahan: item.pnl
        });
    });

    // 2. Urutkan berdasarkan tanggal tertua ke terbaru
    timeline.sort((a, b) => a.tanggal - b.tanggal);

    // 3. Hitung Akumulasi Saldo (Running Balance)
    const labels = [];
    const dataPoints = [];
    let runningBalance = 0;

    timeline.forEach(item => {
        runningBalance += item.perubahan;
        labels.push(item.tanggal.toLocaleDateString('id-ID', {day:'2-digit', month:'short'}));
        dataPoints.push(runningBalance);
    });

    // 4. Gambar Grafik
    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Real Equity Growth',
                data: dataPoints,
                borderColor: '#10b981',
                borderWidth: 3,
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
            }
        }
    });
}
function logout() {
    // Hapus tanda login
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("activeUser");
    // Tendang balik ke login
    window.location.href = "login.html";
}
    </script>
</body>
</html>